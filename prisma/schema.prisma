// ===============================================
// Prisma Schema cho N·ªÅn t·∫£ng SGK ƒêi·ªán T·ª≠
// ===============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===============================================
// User & Role
// ===============================================

enum Role {
  STUDENT
  TEACHER
  ADMIN
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  role      Role     @default(STUDENT)
  isActive  Boolean  @default(true)
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  classMemberships  ClassMembership[]
  studentProgress   StudentProgress[]
  uploadedH5p       H5PContent[]       @relation("H5PUploader")
  trackingEvents    TrackingEvent[]    @relation("TrackingActor")
  uploadedLibraries H5PLibrary[]       @relation("H5PLibraryUploader")
  tempFiles         H5PTemporaryFile[] @relation("H5PTemporaryFileUploader")
  xapiStatements    XApiStatement[]    @relation("XApiActor")

  @@map("users")
}

// ===============================================
// Classes (L·ªõp h·ªçc) & Enrollments
// ===============================================

model Class {
  id          String   @id @default(cuid())
  name        String
  gradeLevel  Int      @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  memberships ClassMembership[]
  books       Book[]  @relation("BookClasses")

  @@map("classes")
}

model ClassMembership {
  id       String   @id @default(cuid())
  userId   String
  classId  String
  joinedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  class Class @relation(fields: [classId], references: [id], onDelete: Cascade)

  @@unique([userId, classId])
  @@map("class_memberships")
}

// ===============================================
// BOOK STRUCTURE (Book ‚Üí Chapter ‚Üí Lesson ‚Üí Page ‚Üí PageBlock)
// ===============================================

model Book {
  id           String   @id @default(cuid())
  title        String
  subject      String
  grade        Int
  description  String?
  coverImage   String?
  publisher    String?
  isPublished  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  chapters Chapter[]
  lessons  Lesson[]
  classes  Class[] @relation("BookClasses")

  @@map("books")
}

model Chapter {
  id          String   @id @default(cuid())
  title       String
  order       Int
  bookId      String
  description String?

  book    Book    @relation(fields: [bookId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@map("chapters")
}

model Lesson {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int
  chapterId   String?
  bookId      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  chapter Chapter? @relation(fields: [chapterId], references: [id], onDelete: SetNull)
  book    Book?    @relation(fields: [bookId], references: [id], onDelete: SetNull)
  pages   Page[]

  @@map("lessons")
}
enum PageType {
  THEORY    // trang thu·∫ßn l√Ω thuy·∫øt
  INTERACTIVE // trang ch·ª©a t∆∞∆°ng t√°c H5P / media
}
model Page {
  id        String   @id @default(cuid())
  lessonId  String
  order     Int
  title     String?
  imageUrl    String?  // URL h√¨nh ·∫£nh b√†i h·ªçc (c√≥ th·ªÉ l√† ·∫£nh ch·ª•p t·ª´ s√°ch gi√°o khoa)
  layout    String? // one-column, two-column, etc.
  type      PageType  @default(THEORY)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  blocks PageBlock[]

  @@map("pages")
}

enum PageBlockType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  H5P
}

model PageBlock {
  id           String        @id @default(cuid())
  pageId       String
  order        Int
  blockType    PageBlockType
  contentJson  Json?
  h5pContentId String?
  xPercent     Float?        // T·ªça ƒë·ªô X theo ph·∫ßn trƒÉm (0-100)
  yPercent     Float?        // T·ªça ƒë·ªô Y theo ph·∫ßn trƒÉm (0-100)
  widthPercent Float?        // Chi·ªÅu r·ªông theo ph·∫ßn trƒÉm (0-100)
  heightPercent Float?       // Chi·ªÅu cao theo ph·∫ßn trƒÉm (0-100)
  audioUrl     String?       // üîä ƒê∆∞·ªùng d·∫´n file mp3 sau khi TTS

  page       Page       @relation(fields: [pageId], references: [id], onDelete: Cascade)
  h5pContent H5PContent? @relation(fields: [h5pContentId], references: [id], onDelete: SetNull)
  progress   StudentProgress[]
  quizConfig QuizConfig?

  @@map("page_blocks")
}

// ===============================================
// STUDENT PROGRESS TRACKING
// ===============================================

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

model StudentProgress {
  id           String         @id @default(cuid())
  userId       String
  pageBlockId  String
  status       ProgressStatus @default(NOT_STARTED)
  completedAt  DateTime?
  lastAccessed DateTime       @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  pageBlock   PageBlock   @relation(fields: [pageBlockId], references: [id], onDelete: Cascade)
  quizAttempts QuizAttempt[]

  @@unique([userId, pageBlockId])
  @@map("student_progress")
}

model QuizAttempt {
  id                String   @id @default(cuid())
  studentProgressId String
  attemptNumber     Int
  score             Float?
  maxScore          Float?
  isPass            Boolean
  statement         Json?
  submittedAt       DateTime @default(now())
  duration          Int?     // Th·ªùi gian l√†m b√†i (gi√¢y)
  
  studentProgress   StudentProgress @relation(fields: [studentProgressId], references: [id], onDelete: Cascade)
  xapiStatements    XApiStatement[]
  questionResponses QuestionResponse[]

  @@map("quiz_attempts")
}

// ===============================================
// QUIZ/EXERCISE CONFIGURATION
// ===============================================

model QuizConfig {
  id              String   @id @default(cuid())
  pageBlockId     String   @unique
  title           String?
  description     String?
  passingScore    Float    @default(70) // ƒêi·ªÉm ƒë·∫°t y√™u c·∫ßu (%)
  weight          Float    @default(1.0) // Tr·ªçng s·ªë c·ªßa b√†i t·∫≠p
  maxAttempts     Int?     // S·ªë l·∫ßn l√†m t·ªëi ƒëa (null = kh√¥ng gi·ªõi h·∫°n)
  timeLimit       Int?     // Gi·ªõi h·∫°n th·ªùi gian (ph√∫t)
  shuffleQuestions Boolean @default(false)
  showFeedback    Boolean  @default(true)
  showCorrectAnswers Boolean @default(true)
  allowReview     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  pageBlock       PageBlock @relation(fields: [pageBlockId], references: [id], onDelete: Cascade)
  questions       QuizQuestion[]

  @@map("quiz_configs")
}

model QuizQuestion {
  id            String   @id @default(cuid())
  quizConfigId  String
  questionText  String
  questionType  String   // multiple-choice, true-false, fill-blank, etc.
  order         Int
  points        Float    @default(1.0)
  h5pContentId  String?  // Link ƒë·∫øn H5P content n·∫øu c√≥
  metadata      Json?    // L∆∞u th√™m th√¥ng tin c√¢u h·ªèi
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  quizConfig    QuizConfig @relation(fields: [quizConfigId], references: [id], onDelete: Cascade)
  h5pContent    H5PContent? @relation(fields: [h5pContentId], references: [id], onDelete: SetNull)
  responses     QuestionResponse[]

  @@map("quiz_questions")
}

model QuestionResponse {
  id              String   @id @default(cuid())
  quizAttemptId   String
  questionId      String
  userAnswer      Json     // C√¢u tr·∫£ l·ªùi c·ªßa h·ªçc sinh
  isCorrect       Boolean
  pointsEarned    Float
  timeSpent       Int?     // Th·ªùi gian l√†m c√¢u n√†y (gi√¢y)
  submittedAt     DateTime @default(now())

  quizAttempt     QuizAttempt @relation(fields: [quizAttemptId], references: [id], onDelete: Cascade)
  question        QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("question_responses")
}

// ===============================================
// xAPI TRACKING (Experience API Standard)
// ===============================================

model XApiStatement {
  id              String   @id @default(cuid())
  statementId     String   @unique // UUID theo chu·∫©n xAPI
  actorId         String   // User th·ª±c hi·ªán h√†nh ƒë·ªông
  verbId          String   // H√†nh ƒë·ªông (completed, attempted, answered, etc.)
  objectId        String   // ƒê·ªëi t∆∞·ª£ng (quiz, question, content)
  objectType      String   // Activity, Agent, etc.
  resultScore     Float?   // ƒêi·ªÉm s·ªë
  resultScoreMin  Float?
  resultScoreMax  Float?
  resultSuccess   Boolean?
  resultCompletion Boolean?
  resultDuration  String?  // ISO 8601 duration
  resultResponse  Json?    // C√¢u tr·∫£ l·ªùi chi ti·∫øt
  contextJson     Json?    // Context theo chu·∫©n xAPI
  timestamp       DateTime @default(now())
  stored          DateTime @default(now())
  authority       Json?    // Th√¥ng tin v·ªÅ h·ªá th·ªëng ghi nh·∫≠n
  version         String   @default("1.0.3") // xAPI version
  attachments     Json?    // Attachments n·∫øu c√≥
  
  // Relations
  quizAttemptId   String?
  h5pContentId    String?
  pageBlockId     String?

  actor           User @relation("XApiActor", fields: [actorId], references: [id], onDelete: Cascade)
  verb            XApiVerb @relation(fields: [verbId], references: [id])
  quizAttempt     QuizAttempt? @relation(fields: [quizAttemptId], references: [id], onDelete: Cascade)
  h5pContent      H5PContent? @relation("XApiH5PTracking", fields: [h5pContentId], references: [id], onDelete: SetNull)

  @@index([actorId, timestamp])
  @@index([verbId])
  @@index([objectId])
  @@map("xapi_statements")
}

model XApiVerb {
  id          String   @id @default(cuid())
  verbIri     String   @unique // IRI theo chu·∫©n xAPI (e.g., http://adlnet.gov/expapi/verbs/completed)
  display     Json     // Display name trong nhi·ªÅu ng√¥n ng·ªØ
  
  statements  XApiStatement[]

  @@map("xapi_verbs")
}

// ===============================================
// QUIZ ANALYTICS & REPORTING
// ===============================================

model QuizAnalytics {
  id                String   @id @default(cuid())
  pageBlockId       String
  userId            String?  // null = analytics cho to√†n b·ªô
  totalAttempts     Int      @default(0)
  averageScore      Float?
  highestScore      Float?
  lowestScore       Float?
  passRate          Float?   // T·ª∑ l·ªá ƒë·∫°t (%)
  averageTimeSpent  Int?     // Th·ªùi gian trung b√¨nh (gi√¢y)
  lastCalculated    DateTime @default(now())
  
  @@unique([pageBlockId, userId])
  @@map("quiz_analytics")
}

// ===============================================
// H5P CONTENT & TRACKING
// ===============================================

model H5PContent {
  id         String   @id @default(cuid())
  title      String
  library    String
  params     Json
  metadata   Json?
  filePath   String?
  uploaderId String
  isPublic   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  uploader       User            @relation("H5PUploader", fields: [uploaderId], references: [id], onDelete: Cascade)
  trackingEvents TrackingEvent[] @relation("H5PTracking")
  pageBlocks     PageBlock[]     // Link t·ª´ c√°c block SGK
  quizQuestions  QuizQuestion[]
  xapiStatements XApiStatement[] @relation("XApiH5PTracking")

  @@map("h5p_contents")
}

model TrackingEvent {
  id        String   @id @default(cuid())
  actorId   String
  verb      String
  objectId  String
  contentId String?
  statement Json
  result    Json?
  context   Json?
  timestamp DateTime @default(now())

  actor   User        @relation("TrackingActor", fields: [actorId], references: [id], onDelete: Cascade)
  content H5PContent? @relation("H5PTracking", fields: [contentId], references: [id], onDelete: SetNull)

  @@map("tracking_events")
}

model H5PLibrary {
  id            String   @id @default(cuid())
  machineName   String
  majorVersion  Int
  minorVersion  Int
  patchVersion  Int
  title         String
  description   String?
  author        String?
  license       String?
  libraryJson   Json
  semanticsJson Json?
  languageJson  Json?
  files         Json?
  dependencies  Json?
  isPublic      Boolean  @default(true)
  uploaderId    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  uploader User? @relation("H5PLibraryUploader", fields: [uploaderId], references: [id], onDelete: SetNull)

  @@unique([machineName, majorVersion, minorVersion, patchVersion])
  @@map("h5p_libraries")
}

model H5PContentLibrary {
  id             String @id @default(cuid())
  contentId      String
  libraryId      String
  dependencyType String // preloaded, dynamic, editor

  @@unique([contentId, libraryId, dependencyType])
  @@map("h5p_content_libraries")
}

model H5PTemporaryFile {
  id        String   @id @default(cuid())
  filename  String
  path      String
  size      BigInt
  mimetype  String
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime

  user User @relation("H5PTemporaryFileUploader", fields: [userId], references: [id], onDelete: Cascade)

  @@map("h5p_temporary_files")
}
